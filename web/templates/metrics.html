<!doctype html><html><body>
<h2>Metrics (snapshot)</h2>
<form method="post" action="/metrics/refresh">
  <button type="submit">Refresh</button>
</form>

<div id="chart-wrap">
  <canvas id="bar" width="800" height="300" style="display:none;"></canvas>
  <svg id="chart-svg" width="800" height="300"></svg>
</div>

<table border="1" cellpadding="6" id="tbl">
<tr><th>Nickname</th><th>IP</th><th>Outlet Count</th></tr>
{% for r in rows %}
<tr><td>{{ r.nick }}</td><td>{{ r.ip }}</td><td>{{ r.outlets }}</td></tr>
{% endfor %}
</table>

<script>
(function(){
  var rows=[{% for r in rows %}{ name: "{{ r.nick }}", value: {{ r.outlets }} },{% endfor %}];
  function drawSVG(){
    var svg=document.getElementById('chart-svg');
    while (svg.firstChild) svg.removeChild(svg.firstChild);
    var w=800, h=300;
    var max=1; rows.forEach(r=>{ if(r.value>max) max=r.value; });
    var barW = Math.max(10, Math.floor((w-40)/Math.max(1, rows.length)));
    rows.forEach(function(r,i){
      var x=20 + i*barW, y=h-20 - Math.round((r.value/max)*(h-60)), bh=(h-20)-y;
      var ns="http://www.w3.org/2000/svg";
      var rect=document.createElementNS(ns,"rect");
      rect.setAttribute("x",x); rect.setAttribute("y",y); rect.setAttribute("width",barW-4); rect.setAttribute("height",bh);
      rect.setAttribute("fill","#8888ff");
      svg.appendChild(rect);
      var tx=document.createElementNS(ns,"text");
      tx.setAttribute("x", x+2); tx.setAttribute("y", h-5); tx.setAttribute("font-size","10"); tx.textContent=r.name;
      svg.appendChild(tx);
    });
  }
  function drawChartJS(){
    var c=document.getElementById('bar'); c.style.display='block';
    var ctx=c.getContext('2d');
    /* global Chart */
    new Chart(ctx, {
      type: 'bar',
      data: { labels: rows.map(r=>r.name),
              datasets: [{ label: 'Outlets', data: rows.map(r=>r.value) }]},
      options: { responsive: false, scales: { y: { beginAtZero: true } } }
    });
    document.getElementById('chart-svg').style.display='none';
  }
  var s=document.createElement('script');
  s.src='/static/chart.umd.js';
  s.onload=function(){ try { if (window.Chart) { drawChartJS(); return; } } catch(e){} drawSVG(); };
  s.onerror=function(){ drawSVG(); };
  document.head.appendChild(s);
})();
</script>

<p><a href="/">Back</a></p>
</body></html>
